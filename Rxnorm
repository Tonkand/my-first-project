https://www.nlm.nih.gov/research/umls/rxnorm/docs/index.html

TTY | å…¨å | èªªæ˜
IN | Ingredient | å–®ä¸€è—¥å“æˆåˆ†ï¼Œä¾‹å¦‚ Amoxicillin
MIN | Multiple Ingredients | å¤šæˆåˆ†è—¥ï¼Œä¾‹å¦‚ Amoxicillin / Clavulanate
PIN | Precise Ingredient | æ›´å…·é«”çš„æˆåˆ†ï¼ˆå¦‚é¹½é¡ã€é¹½é…¸é¹½ï¼‰ä¾‹å¦‚ Amoxicillin sodium
SCD | Semantic Clinical Drug | é€šç”¨è—¥ + åŠ‘é‡ + åŠ‘å‹ï¼Œä¾‹å¦‚ Amoxicillin 250 MG Oral Capsule
SBD | Semantic Branded Drug | å“ç‰Œè—¥ + åŠ‘é‡ + åŠ‘å‹ï¼Œä¾‹å¦‚ Amoxil 250 MG Oral Capsule
GPCK | Generic Pack | é€šç”¨è—¥åŒ…è£ï¼Œä¾‹å¦‚ Amoxicillin 250 MG Oral Capsule Pack
BPCK | Branded Pack | å“ç‰Œè—¥åŒ…è£ï¼Œä¾‹å¦‚ Amoxil 250 MG Oral Capsule Pack
BN | Brand Name | å“ç‰Œåï¼ˆä¸å«åŠ‘å‹åŠ‘é‡ï¼‰ï¼Œä¾‹å¦‚ Amoxil
DF | Dose Form | åŠ‘å‹åç¨±ï¼Œå¦‚ Oral Capsule
DFG | Dose Form Group | åŠ‘å‹é¡åˆ¥ï¼Œå¦‚ Oral Dosage Formsï¼ˆå£æœé¡ï¼‰
CD | Clinical Drug (DEPRECATED) | èˆŠç‰ˆçš„ clinical drug æ¢ç›®ï¼Œå·²è¢« SCD å–ä»£
AB | Branded Drug Abbreviation | å“ç‰Œåç¸®å¯«ï¼Œä¾‹å¦‚ Tylenolï¼ˆå¯èƒ½æ˜ å°„å¤šå€‹å¯¦é«”ï¼‰
SCDF | Semantic Clinical Dose Form | é€šç”¨åŠ‘å‹ + åŠ‘å‹ï¼Œä¾‹å¦‚ Amoxicillin Oral Capsule
SBDF | Semantic Branded Dose Form | å“ç‰ŒåŠ‘å‹ + åŠ‘å‹ï¼Œä¾‹å¦‚ Amoxil Oral Capsule
TTY	å…¨å	èªªæ˜
CDA	Clinical Drug Component - Abstract	æŠ½è±¡è—¥å“çµ„ä»¶ï¼Œä¸å¸¶æœ‰åŠ‘é‡å…·é«”è³‡è¨Šï¼Œä½†ä»£è¡¨ä¸€å€‹æ²»ç™‚æˆåˆ†çš„ã€Œè—¥åŠ‘é¡å‹ã€æ¦‚å¿µï¼Œä¾‹å¦‚ "Amoxicillin Oral Product"
CDC	Clinical Drug Component	çµ„ä»¶å‹è—¥å“æ¢ç›®ï¼Œæœ‰åŠ‘å‹ä½†ä¸å…·å“ç‰Œèˆ‡åŒ…è£è³‡è¨Šï¼Œé€šå¸¸æ˜¯ä¸­é–“å±¤æ¦‚å¿µã€‚ä¾‹å¦‚ä¸€ç¨®æˆåˆ† + åŠ‘å‹çš„çµ„åˆ
CDD	Clinical Drug	è‡¨åºŠè—¥å“ï¼Œé¡ä¼¼æ–¼ SCDï¼Œä½†èªç¾©ç¯„åœæ›´å»£ï¼Œæœªå¿…æœ‰æ˜ç¢ºçš„åŠ‘é‡ï¼Œä¾‹å¦‚ â€œAmoxicillin oral capsule productâ€

TTY ç±»å‹	ä½ å¯ä»¥ç”¨å®ƒåšä»€ä¹ˆï¼Ÿ
IN, PIN, MIN	è·å–è¯å“åŸå§‹æˆåˆ†
SCD, SBD	è·å–ç»“æ„åŒ–è¯å“ï¼ˆå‰‚å‹ + å¼ºåº¦ + æˆåˆ†ï¼‰
BN	è·å–å“ç‰Œåæ˜ å°„
BPCK, GPCK	è·å–ä¸åŒåŒ…è£…å•ä½


conso_columns = ['rxcui','lat','ts','lui','stt','sui','ispref','rxaui','saui','scui','sdui','sab','tty','code','str','srl','suppress','cvf','test']
sat_columns = ['rxcui','lui','sui','rxaui','stype','code','atui','satui','atn','sab','atv','suppress','cvf','test']
upper_list = [item.upper() for item in conso_colum
RXNREL = pd.read_csv("RXNREL.RRF", sep='|', header=None, dtype=str)
RXNREL_columns = ["RXCUI1","RXAUI1","STYPE1","REL","RXCUI2","RXAUI2","STYPE2","RELA","RUI","SRUI","SAB","SL","RG","DIR","SUPPRESS","CVF","test"]
RXNREL.columns = RXNREL_columns
######


####
import pandas as pd

# è¼‰å…¥æ‰€éœ€çš„ RRF æª”æ¡ˆï¼ˆæ³¨æ„ sep='\t'ï¼ŒRxNorm æ˜¯ | åˆ†éš”ï¼‰
rxnsat = pd.read_csv("RXNSAT.RRF", sep="|", header=None, dtype=str, usecols=[0, 3, 4, 5])
rxnsat.columns = ['RXCUI', 'ATN', 'SAB', 'ATV']

rxnrel = pd.read_csv("RXNREL.RRF", sep="|", header=None, dtype=str, usecols=[0, 4, 7])
rxnrel.columns = ['RXCUI1', 'RXCUI2', 'REL']  # REL = 'has_ingredient'

rxnconso = pd.read_csv("RXNCONSO.RRF", sep="|", header=None, dtype=str, usecols=[0, 14])
rxnconso.columns = ['RXCUI', 'STR']

# ğŸ” 1. æ‰¾å‡ºè©² application number å°æ‡‰çš„ RXCUI
application_number = "ANDA076683"
target_rx = rxnsat[(rxnsat['ATN'] == 'APPLICATION_NUMBER') & (rxnsat['ATV'] == application_number)]

if target_rx.empty:
    print("âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„ RXCUI")
else:
    rxcui = target_rx.iloc[0]['RXCUI']
    print(f"âœ… æ‰¾åˆ° RXCUI: {rxcui}")

    # ğŸ” 2. å¾ RXNREL æ‰¾å‡º has_ingredient æˆ– consists_of çš„æˆåˆ† RXCUI
    ingredient_rel = rxnrel[
        (rxnrel['RXCUI1'] == rxcui) &
        (rxnrel['REL'].isin(['has_ingredient', 'consists_of']))
    ]

    if ingredient_rel.empty:
        print("âš ï¸ æ²’æ‰¾åˆ°æˆåˆ†é—œä¿‚")
    else:
        ingredient_rxcuis = ingredient_rel['RXCUI2'].unique()

        # ğŸ” 3. å¾ RXNCONSO æ‰¾å‡ºé€™äº›æˆåˆ†çš„åç¨±
        ingredient_names = rxnconso[rxnconso['RXCUI'].isin(ingredient_rxcuis)]
        print("ğŸ’Š Active Ingredient(s):")
        for name in ingredient_names['STR'].unique():
            print(" -", name)

########
import pandas as pd
import difflib

# è¯»å– RxNorm æ•°æ®
df = conso.copy()

# åªæå–ç»“æ„åŒ–è¯å“ï¼ˆSCD, SBDï¼‰
df = df[(df["LAT"] == "ENG") & (df["TTY"].isin(["IN","SCD", "SBD"]))]

def find_top_rxcui_matches(input_text, topn=10):
    input_text = input_text.lower()
    names = df["STR"].str.lower().tolist()
    matches = difflib.get_close_matches(input_text, names, n=topn, cutoff=0.3)

    results = df[df["STR"].str.lower().isin(matches)][["RXCUI", "STR"]].drop_duplicates().head(topn)
    return results.reset_index(drop=True)

# ç¤ºä¾‹æŸ¥è¯¢
query = "Choline fenofibrate"
top_matches = find_top_rxcui_matches(query)
print(top_matches)

#########
####
# -*- coding: utf-8 -*-
import pandas as pd
import numpy as np
from transformers import AutoTokenizer, AutoModel
import torch
from sklearn.metrics.pairwise import cosine_similarity

# ---------- Load PubMedBERT ----------
tokenizer = AutoTokenizer.from_pretrained("microsoft/BiomedNLP-PubMedBERT-base-uncased-abstract")
model = AutoModel.from_pretrained("microsoft/BiomedNLP-PubMedBERT-base-uncased-abstract")

# ---------- Get Embedding ----------
def get_embedding(text):
    inputs = tokenizer(text, return_tensors="pt", truncation=True, max_length=32)
    with torch.no_grad():
        outputs = model(**inputs)
    return outputs.last_hidden_state.mean(dim=1).squeeze().numpy()

# ---------- Load RxNorm STR Data ----------
df_raw = conso.copy()
df_drugs = df_raw[(df_raw["LAT"] == "ENG") & (df_raw["TTY"].isin(["SCD", "SBD"]))]
df_drugs = df_drugs[["RXCUI", "STR"]].drop_duplicates().dropna().reset_index(drop=True)

# ---------- Build Embedding Cache ----------
def build_embedding_cache(df):
    print("Generating embeddings for RxNorm drugs...")
    df["embedding"] = df["STR"].apply(get_embedding)
    return df

# ---------- Batch Search ----------
def find_top_similar_for_list(query_list, df, topn=10):
    results = []
    for query in query_list:
        query_vec = get_embedding(query)
        all_vecs = np.stack(df["embedding"].values)
        sims = cosine_similarity([query_vec], all_vecs)[0]
        df_temp = df.copy()
        df_temp["score"] = sims
        top_hits = df_temp.sort_values("score", ascending=False).head(topn)
        top_hits["query"] = query
        results.append(top_hits[["query", "RXCUI", "STR", "score"]])
    return pd.concat(results).reset_index(drop=True)

# ---------- Drug Similarity Matrix ----------
def drug_similarity_matrix(drug_list):
    vecs = [get_embedding(drug) for drug in drug_list]
    sim_matrix = cosine_similarity(vecs)
    return pd.DataFrame(sim_matrix, index=drug_list, columns=drug_list)

# ---------- Example ----------
if __name__ == "__main__":
    drug_queries = [
        "amoxicillin and clavulanate potassium",
        "ibuprofen",
        "omeprazole",
        "acetaminophen",
        "metformin"
    ]

    df_drugs = build_embedding_cache(df_drugs)

    print("\nTop 10 similar drugs for each:")
    top_results = find_top_similar_for_list(drug_queries, df_drugs, topn=10)
    print(top_results)

    print("\nSemantic similarity matrix:")
    sim_matrix = drug_similarity_matrix(drug_queries)
    print(sim_matrix.round(3))
